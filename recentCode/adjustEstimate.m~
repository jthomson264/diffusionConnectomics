%  Pull in the estimate.
load('~/data/mybrain/nuHatUnadjusted');

%  Pull in the smallNII that you're going to change.
load('~/data/mybrain/smalldata.nii');
nx = data.hdr.dime.dim(2);
ny = data.hdr.dime.dim(3);
nz = data.hdr.dime.dim(4);

%  Pull in bvalues and make the btable stuff.
load('~/data/mybrain/btab');
bvec = btab(:,2:4);

for i = 1:3
  bvec(:,i) = bvec(:,i) .* sqrt(btab(:,1));
end

intBvecs = [bvec; -bvec(2:515,:)];
intBvecs = intBvecs / max(max(intBvecs));

gridNumber = 5;
intBvecs = round(intBvecs*5) + 5 + 1;

%  Pull the sigma2s;
load('~/Desktop/code/hdft_tools/sigs.mat');


disp('Loaded in and prepped all data, beginning to add in scans...');



%  Now loop through q vectors and replace the data in data.img.
for i = 1:515

  sigma = sigmas(i);

  qx = intBvecs(i,1);
  qy = intBvecs(i,2);
  qz = intBvecs(i,3);

  data.img(:,:,:,i) = nuHat(:,:,:,qx, qy, qz) * sigma;
  disp('Added in one scan...');

end

save_nii(data, '~/data/mybrain/smallNuHats.nii');
